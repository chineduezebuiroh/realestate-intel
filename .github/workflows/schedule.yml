name: Scheduled ETL + Forecast

on:
  schedule:
    - cron: "12 9 * * 1"   # every Monday 09:12 UTC
  workflow_dispatch: {}


jobs:
  run:
    runs-on: ubuntu-latest
    env:
      # Map the repository secret into an environment variable for all steps
      FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Show files
        run: |
          pwd
          ls -la



      # Ingest and Transform Redfin (DC) Data
      - name: Ingest DC (Redfin)
        env:
          ALLOW_REDFIN_FAIL: "1"
        run: make ingest_dc
        
      - name: Transform DC (weekly Redfin)
        run: make transform_dc
        

      # Ingest and Transform Monthly Zillow annd FRED Unemployment (DC) Data
      - name: Verify FRED_API_KEY is detected (masked)
        run: |
          if [ -z "${FRED_API_KEY}" ]; then
            echo "❌ FRED_API_KEY is NOT set"
            exit 1
          else
            echo "✅ FRED_API_KEY detected (value masked)"
            echo "${FRED_API_KEY}" | wc -c | xargs echo "Length of key (should be ~32-40 chars):"
          fi

      - name: Ingest Monthlies (Zillow + FRED)
        env:
          ALLOW_ZILLOW_FAIL: "1"
        run: make ingest_monthly

      - name: Transform Monthlies (ZORI + Unemployment)
        run: make transform_monthly

        
      # Ingest and Transform BLS LAUS (DC) Data
      - name: Ingest BLS LAUS (DC)
        run: make ingest_bls

      - name: Transform BLS LAUS
        run: make transform_bls

        
      # Ingest and Transform FRED Mortgage Rates Data
      - name: Ingest FRED Mortgage Rates
        run: make ingest_fred_rates

      - name: Transform FRED Mortgage Rates
        run: make transform_fred_rates

        
      # Ingest and Transform FRED Yields Data
      - name: Ingest FRED Yields
        run: make ingest_fred_yields

      - name: Transform FRED Yields
        run: make transform_fred_yields

        
      # Ingest and Transform Redfin Weekly Trends Data
      - name: Ingest Redfin Market Trends (weekly)
        run: make ingest_redfin
        env:
          # Optional mirror if S3 blocks; leave unset if you don’t have one
          REDFIN_MIRRORS: ${{ secrets.REDFIN_MIRRORS }}
          # Optional: custom UA if needed
          REDFIN_USER_AGENT: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36
          # Cache freshness (days) before re-downloading
          REDFIN_CACHE_DAYS: "7"

      - name: Transform Redfin → fact_timeseries
        run: make transform_redfin



      # Optional: print a quick summary for debugging
      - name: Verify row counts
        run: |
          python - << 'PY'
          import duckdb
          con = duckdb.connect("./data/market.duckdb", read_only=True)
          print(con.execute("SELECT geo_id, COUNT(*) AS n FROM fact_timeseries GROUP BY 1 ORDER BY 1").fetchdf())
          print(con.execute("SELECT metric_id, MIN(date), MAX(date), COUNT(*) FROM fact_timeseries WHERE metric_id LIKE 'redfin_%' GROUP BY 1 ORDER BY 1").fetchdf())
          con.close()
          PY
        


      - name: Forecast DC (placeholder)
        run: make forecast_dc
